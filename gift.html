<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>A Special Surprise for Simran</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400..900;1,400..900&family=Satisfy&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --primary-red: #d90429;
            --rose-gold: #e5b3a8;
            --deep-rose: #c9184a;
            --soft-pink: #fff0f3;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(180deg, #fff5f5 0%, #ffe4e6 100%);
            min-height: 100dvh;
            margin: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            touch-action: manipulation;
        }

        /* Ambient Magical Background */
        .bg-glow {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200vw;
            height: 200vh;
            background: radial-gradient(circle at center, rgba(255, 175, 190, 0.3) 0%, rgba(255, 255, 255, 0) 60%);
            z-index: 0;
            animation: pulse-glow 10s infinite alternate ease-in-out;
        }

        @keyframes pulse-glow {
            0% { opacity: 0.4; transform: translate(-50%, -50%) scale(0.8); }
            100% { opacity: 0.7; transform: translate(-50%, -50%) scale(1.2); }
        }

        /* --- Mystery Box Section --- */
        #mystery-box-container {
            position: relative;
            z-index: 20;
            cursor: pointer;
            perspective: 1200px;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
        }

        #mystery-box {
            position: relative;
            width: 130px;
            height: 130px;
            transform-style: preserve-3d;
            animation: box-float 4s infinite ease-in-out;
        }

        #mystery-box::after {
            content: '';
            position: absolute;
            bottom: -40px;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 15px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            filter: blur(8px);
            animation: shadow-pulse 4s infinite ease-in-out;
            z-index: -1;
        }

        @keyframes box-float {
            0%, 100% { transform: translateY(0) rotateY(0deg); }
            50% { transform: translateY(-20px) rotateY(5deg); }
        }

        @keyframes shadow-pulse {
            0%, 100% { transform: translateX(-50%) scale(1); opacity: 0.2; }
            50% { transform: translateX(-50%) scale(1.3); opacity: 0.1; }
        }

        #mystery-box .lid {
            position: absolute;
            width: 146px;
            height: 40px;
            background: linear-gradient(135deg, #ef233c, var(--primary-red));
            top: -5px;
            left: -8px;
            border-radius: 4px;
            z-index: 10;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform-origin: bottom;
            transition: all 0.9s cubic-bezier(0.5, 0, 0.1, 1);
        }

        #mystery-box .box-body {
            position: absolute;
            width: 130px;
            height: 100px;
            background: linear-gradient(135deg, var(--primary-red), #8d021f);
            top: 30px;
            border-radius: 2px;
            box-shadow: 0 10px 30px rgba(217, 4, 41, 0.25);
        }

        .ribbon-v {
            position: absolute;
            width: 20px;
            height: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(to right, #ffd700, #ffec8b, #ffd700);
        }
        .ribbon-h {
            position: absolute;
            height: 20px;
            width: 100%;
            top: 50%;
            transform: translateY(-50%);
            background: linear-gradient(to bottom, #ffd700, #ffec8b, #ffd700);
        }

        #mystery-box.open .lid {
            transform: translateY(-120px) rotateX(-160deg);
            opacity: 0;
        }

        /* --- Message Card --- */
        .card {
            position: fixed;
            width: 88%;
            max-width: 360px;
            background: rgba(255, 255, 255, 0.82);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border-radius: 35px;
            padding: 2rem 1.5rem;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 20px 60px -10px rgba(217, 4, 41, 0.12);
            opacity: 0;
            visibility: hidden;
            transform: scale(0.8) translateY(100px);
            transition: all 1.2s cubic-bezier(0.19, 1, 0.22, 1);
            z-index: 30;
        }

        .card.visible {
            opacity: 1;
            visibility: visible;
            transform: scale(1) translateY(0);
        }

        .recipient-name {
            font-family: 'Satisfy', cursive;
            font-size: clamp(2.5rem, 8vw, 3.5rem);
            background: linear-gradient(to bottom, var(--primary-red), var(--deep-rose));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.2rem;
        }

        .shayari-line {
            display: block;
            font-family: 'Playfair Display', serif;
            font-size: 1.05rem;
            line-height: 1.6;
            color: #1a1a1a;
            margin-bottom: 0.4rem;
        }

        /* --- Gemini Features Styling --- */
        .ai-button {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .ai-button:active {
            transform: scale(0.95);
        }

        .loading-dots:after {
            content: ' .';
            animation: dots 1.5s steps(5, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: ' .'; }
            40% { content: ' ..'; }
            60% { content: ' ...'; }
            80%, 100% { content: ''; }
        }

        /* Fixed Butterfly Animation - Parent handles flight, Child handles flutter */
        .butterfly-particle {
            position: fixed;
            pointer-events: none;
            z-index: 100;
            opacity: 0;
            animation: butterfly-fly var(--duration) ease-out forwards;
        }

        .butterfly-inner {
            display: inline-block;
            font-size: 1.5rem;
            animation: butterfly-flutter 0.3s ease-in-out infinite alternate;
        }

        @keyframes butterfly-fly {
            0% { transform: translate(0, 0) scale(0.1); opacity: 0; }
            15% { opacity: 1; transform: translate(var(--mx), var(--my)) scale(1.1); }
            100% { transform: translate(var(--tx), var(--ty)) scale(0.4); opacity: 0; }
        }

        @keyframes butterfly-flutter {
            from { transform: rotate(-15deg) skewY(-5deg); }
            to { transform: rotate(15deg) skewY(5deg); }
        }

        .sparkle {
            position: fixed;
            width: 3px;
            height: 3px;
            background: white;
            border-radius: 50%;
            pointer-events: none;
            z-index: 99;
            box-shadow: 0 0 6px #ffd700;
            animation: sparkle-move var(--duration) ease-out forwards;
        }

        @keyframes sparkle-move {
            0% { transform: translate(0,0) scale(1.5); opacity: 1; }
            100% { transform: translate(var(--tx), var(--ty)) scale(0); opacity: 0; }
        }

        /* Message Overlay for Errors/Status */
        #status-toast {
            position: fixed;
            bottom: 2rem;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 50px;
            font-size: 0.8rem;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1000;
            pointer-events: none;
        }
    </style>
</head>
<body>

    <div class="bg-glow"></div>
    <div id="status-toast"></div>

    <!-- The Box Section -->
    <div id="mystery-box-container">
        <div id="mystery-box">
            <div class="lid"><div class="ribbon-v"></div></div>
            <div class="box-body">
                <div class="ribbon-v"></div>
                <div class="ribbon-h"></div>
            </div>
        </div>
        <div class="text-center mt-20 px-6">
            <span class="text-xs uppercase tracking-[0.2em] font-semibold text-rose-300 animate-pulse">Tap to Unveil</span>
        </div>
    </div>

    <!-- The Message Card -->
    <div class="card">
        <div class="content relative">
            <span class="text-[0.6rem] uppercase tracking-[0.4em] text-rose-300 font-bold block mb-1">Magical Moment</span>
            <h2 class="recipient-name">Simran</h2>
            
            <div class="flex justify-center items-center gap-2 my-4">
                <div class="w-8 h-[1px] bg-rose-200"></div>
                <span class="text-rose-300 text-xs">âœ¨</span>
                <div class="w-8 h-[1px] bg-rose-200"></div>
            </div>
            
            <div id="shayari-container" class="min-h-[120px] transition-opacity duration-500">
                <span class="shayari-line">"Main tod leta agar tu gulaab hoti,</span>
                <span class="shayari-line">Main jawaab banta agar tu sawaal hoti.</span>
                <span class="shayari-line">Sab jaante hain main nasha nahi karta,</span>
                <span class="shayari-line">Magar main bhi pee leta agar tu sharaab hoti."</span>
            </div>

            <div class="mt-8 pt-4 border-t border-rose-100 grid grid-cols-2 gap-3">
                <button id="ai-rewrite" class="ai-button py-2.5 px-3 bg-gradient-to-r from-rose-400 to-pink-500 text-white rounded-full text-[0.7rem] font-bold shadow-lg shadow-rose-200">
                    âœ¨ Transform Poetry
                </button>
                <button id="ai-tts" class="ai-button py-2.5 px-3 bg-white border border-rose-200 text-rose-500 rounded-full text-[0.7rem] font-bold shadow-md">
                    âœ¨ Hear the Whisper
                </button>
            </div>
            
            <p class="mt-4 text-[0.6rem] text-rose-300 tracking-[0.1em] italic">AI Powered Magic</p>
        </div>
    </div>

    <script>
        const apiKey = ""; // Environment will provide this
        const boxContainer = document.getElementById('mystery-box-container');
        const mysteryBox = document.getElementById('mystery-box');
        const card = document.querySelector('.card');
        const shayariContainer = document.getElementById('shayari-container');
        const toast = document.getElementById('status-toast');

        // Gemini API Utility with Exponential Backoff
        async function callGemini(payload, isTTS = false) {
            const model = isTTS ? 'gemini-2.5-flash-preview-tts' : 'gemini-2.5-flash-preview-09-2025';
            const endpoint = isTTS ? 'generateContent' : 'generateContent';
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:${endpoint}?key=${apiKey}`;
            
            let delay = 1000;
            for (let i = 0; i < 5; i++) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    return await response.json();
                } catch (error) {
                    if (i === 4) throw error;
                    await new Promise(r => setTimeout(r, delay));
                    delay *= 2;
                }
            }
        }

        // Show Toast Utility
        function showToast(msg) {
            toast.innerText = msg;
            toast.style.opacity = '1';
            setTimeout(() => toast.style.opacity = '0', 3000);
        }

        // --- Box Opening Logic ---
        boxContainer.addEventListener('click', () => {
            mysteryBox.classList.add('open');
            triggerMagic();
            setTimeout(() => {
                boxContainer.style.transition = 'all 0.8s ease';
                boxContainer.style.opacity = '0';
                boxContainer.style.transform = 'translateY(-30px) scale(0.9)';
                setTimeout(() => {
                    boxContainer.style.display = 'none';
                    card.classList.add('visible');
                }, 600);
            }, 700);
        });

        // --- âœ¨ AI Rewrite Logic ---
        document.getElementById('ai-rewrite').addEventListener('click', async (e) => {
            const btn = e.currentTarget;
            if (btn.classList.contains('processing')) return;
            
            btn.classList.add('processing');
            btn.innerHTML = 'âœ¨ Casting Spell<span class="loading-dots"></span>';
            shayariContainer.style.opacity = '0.3';

            const prompts = [
                "Rewrite this shayari for Simran to be more ethereal and celestial.",
                "Rewrite this shayari for Simran to be soulful and deeply romantic.",
                "Rewrite this shayari for Simran to be whimsical and playful.",
                "Rewrite this shayari for Simran to be a modern love poem."
            ];
            const randomPrompt = prompts[Math.floor(Math.random() * prompts.length)];

            const payload = {
                contents: [{
                    parts: [{
                        text: `Context: This is a surprise gift for someone named Simran. 
                        Prompt: ${randomPrompt} 
                        Current Text: ${shayariContainer.innerText}
                        Rule: Keep it in a few poetic lines. Use Hindi/Urdu written in Roman script if possible. Only return the poem lines, nothing else.`
                    }]
                }]
            };

            try {
                const data = await callGemini(payload);
                const newPoem = data.candidates?.[0]?.content?.parts?.[0]?.text || shayariContainer.innerText;
                
                // Format lines
                const lines = newPoem.split('\n').filter(l => l.trim().length > 0).slice(0, 4);
                shayariContainer.innerHTML = lines.map(line => `<span class="shayari-line">${line.replace(/"/g, '')}</span>`).join('');
                
                triggerMagic(); // Add extra sparkles for new poem
            } catch (err) {
                showToast("Magic fizzled out! Try again.");
            } finally {
                btn.classList.remove('processing');
                btn.innerHTML = 'âœ¨ Transform Poetry';
                shayariContainer.style.opacity = '1';
            }
        });

        // --- âœ¨ AI TTS Logic ---
        document.getElementById('ai-tts').addEventListener('click', async (e) => {
            const btn = e.currentTarget;
            if (btn.classList.contains('processing')) return;

            btn.classList.add('processing');
            btn.innerHTML = 'âœ¨ Warming Voice<span class="loading-dots"></span>';

            const textToSpeak = shayariContainer.innerText.replace(/\n/g, ". ");
            const payload = {
                contents: [{ parts: [{ text: `Say gently and romantically: ${textToSpeak}` }] }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Leda" } } }
                }
            };

            try {
                const data = await callGemini(payload, true);
                const base64Audio = data.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;
                
                if (base64Audio) {
                    const audioBlob = pcmToWav(base64Audio, 24000);
                    const audioUrl = URL.createObjectURL(audioBlob);
                    const audio = new Audio(audioUrl);
                    audio.play();
                }
            } catch (err) {
                showToast("Couldn't catch the whisper.");
            } finally {
                btn.classList.remove('processing');
                btn.innerHTML = 'âœ¨ Hear the Whisper';
            }
        });

        // Convert PCM16 to WAV Utility
        function pcmToWav(base64Data, sampleRate) {
            const byteCharacters = atob(base64Data);
            const byteNumbers = new Array(byteCharacters.length);
            for (let i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i);
            }
            const byteArray = new Uint8Array(byteNumbers);
            const buffer = byteArray.buffer;
            
            const wavHeader = new ArrayBuffer(44);
            const view = new DataView(wavHeader);
            
            view.setUint32(0, 0x52494646, false); // "RIFF"
            view.setUint32(4, 36 + buffer.byteLength, true); // Size
            view.setUint32(8, 0x57415645, false); // "WAVE"
            view.setUint32(12, 0x666d7420, false); // "fmt "
            view.setUint32(16, 16, true); // Subchunk 1 size
            view.setUint16(20, 1, true); // Audio format (PCM)
            view.setUint16(22, 1, true); // Num channels
            view.setUint32(24, sampleRate, true); // Sample rate
            view.setUint32(28, sampleRate * 2, true); // Byte rate
            view.setUint16(32, 2, true); // Block align
            view.setUint16(34, 16, true); // Bits per sample
            view.setUint32(36, 0x64617461, false); // "data"
            view.setUint32(40, buffer.byteLength, true); // Subchunk 2 size

            return new Blob([wavHeader, buffer], { type: 'audio/wav' });
        }

        // --- Fixed Visual Effects ---
        function triggerMagic() {
            const rect = mysteryBox.style.display === 'none' ? card.getBoundingClientRect() : mysteryBox.getBoundingClientRect();
            const x = rect.left + rect.width / 2;
            const y = rect.top + rect.height / 2;
            for (let i = 0; i < 24; i++) setTimeout(() => createButterfly(x, y), i * 35);
            for (let i = 0; i < 20; i++) createSparkle(x, y);
        }

        function createButterfly(x, y) {
            const b = document.createElement('div');
            b.className = 'butterfly-particle';
            
            // Nested element handles the flutter so transforms don't conflict
            const inner = document.createElement('div');
            inner.className = 'butterfly-inner';
            const variety = ['ðŸ¦‹', 'âœ¨', 'ðŸŒ¸', 'ðŸ¦‹'];
            inner.innerHTML = variety[Math.floor(Math.random() * variety.length)];
            b.appendChild(inner);

            b.style.left = x + 'px'; 
            b.style.top = y + 'px';
            
            const angle = Math.random() * Math.PI * 2;
            const dist = 250 + Math.random() * 350;
            const tx = Math.cos(angle) * dist;
            const ty = Math.sin(angle) * dist - 120; // Upward bias
            
            const duration = 2.5 + Math.random() * 2;
            
            b.style.setProperty('--tx', `${tx}px`);
            b.style.setProperty('--ty', `${ty}px`);
            b.style.setProperty('--mx', `${tx * 0.4}px`);
            b.style.setProperty('--my', `${ty * 0.4}px`);
            b.style.setProperty('--duration', `${duration}s`);
            
            document.body.appendChild(b);
            setTimeout(() => b.remove(), duration * 1000);
        }

        function createSparkle(x, y) {
            const s = document.createElement('div');
            s.className = 'sparkle';
            s.style.left = x + 'px'; s.style.top = y + 'px';
            const angle = Math.random() * Math.PI * 2;
            const dist = 120 + Math.random() * 250;
            const duration = 1 + Math.random() * 2;
            s.style.setProperty('--tx', `${Math.cos(angle) * dist}px`);
            s.style.setProperty('--ty', `${Math.sin(angle) * dist}px`);
            s.style.setProperty('--duration', `${duration}s`);
            document.body.appendChild(s);
            setTimeout(() => s.remove(), duration * 1000);
        }

        document.addEventListener('touchmove', (e) => {
            if (e.target.closest('.card')) return;
            e.preventDefault();
        }, { passive: false });
    </script>
</body>
</html>